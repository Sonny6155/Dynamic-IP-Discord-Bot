// Dynamic IP bot
// Version: 1.0
// Author: Sonny6155

// This Discord bot to compares the external IP of the host to their previous IP every 10 seconds.
// The IP will be posted if a change is detected.


var Discord = require("discord.js");
var ip = require("ip"); // Allows IP check

var DynamicIPBot = new Discord.Client();
var token = "";

let prefix = !;

var newIP;
var previousIP;
var checkClock;
var isRunning;



DynamicIPBot.on("ready", () =>
{
    console.log("Ready");
});

// Listen for messages
DynamicIPBot.on("message", msg =>
{
  if (!msg.content.startsWith(prefix)) return; // End immediately if prefix is not found
  if(msg.author.bot) return; // Prevent bot loops

  // Ping test
  if (msg.content.startsWith(prefix + "ping"))
  {
    msg.channel.sendMessage("Pong!");
  }


  if (msg.content.startsWith(prefix + "currentIP"))
  {
	 msg.channel.sendMessage(ip.address()); // Does not update new IP
  }

  if (msg.content.startsWith(prefix + "help"))
  {
    listCommands(msg.author);
  }


  if (msg.content.startsWith(prefix + "start"))
  {
    // Check user perms *
    if(isRunning)
    {
      msg.channel.sendMessage("Error: The IP check is already running!");
    }
    else
    {
      isRunning = true;
      var checkClock = setinterval(checkIP(msg.channel), 10000);
    }
  }

  if (msg.content.startsWith(prefix + "stop"))
  {
    // Check user perms *
    clearInterval(checkClock);
    isRunning = false;
  }
}



function checkIP(channel)
{
	newIP = ip.address();
	console.log("var newIP = " + newIP); // Temporary debug
	console.log("var previousIP = " + previousIP);
	if(newIP !== previousIP)
	{
		console.log("IP change detected");
		console.log("New IP: " + newIP);
		channel.sendMessage("New IP: " + newIP);
	}
	previousIP = newIP;
}

function listCommands(author)
{
  // DM author
  // Host commands
}



// Error listener
BrainpowerBot.on('error', e => { console.error(e); });

BrainpowerBot.login(token);
